{
    # Enable admin API for internal use if needed, but restrict it
    admin off

    # Trust private IP ranges (Docker network)
    # This allows Caddy to trust headers if we add another layer later (like Cloudflare)
    servers {
        # Trust Docker internal IPs AND Cloudflare IPs
        # Source: https://www.cloudflare.com/ips/
        trusted_proxies static private_ranges 173.245.48.0/20 103.21.244.0/22 103.22.200.0/22 103.31.4.0/22 141.101.64.0/18 108.162.192.0/18 190.93.240.0/20 188.114.96.0/20 197.234.240.0/22 198.41.128.0/17 162.158.0.0/15 104.16.0.0/13 104.24.0.0/14 172.64.0.0/13 131.0.72.0/22 2400:cb00::/32 2606:4700::/32 2803:f800::/32 2405:b500::/32 2405:8100::/32 2a06:98c0::/29 2c0f:f248::/32
    }
}

api.vaishakmenon.com {
    # Proxy to the API service
    reverse_proxy api:8000 {
        # Standard proxy headers are set automatically by Caddy usually,
        # but we ensure they are passed through correctly.
        header_up Host {host}
        header_up X-Real-IP {remote}
        header_up X-Forwarded-For {remote}
        header_up X-Forwarded-Proto {scheme}
    }

    # Enable compression
    encode gzip

    # Logging
    log {
        output file /var/log/caddy/access.log {
            roll_size 10mb
            roll_keep 5
        }
    }
}

grafana.vaishakmenon.com {
    # Proxy to Grafana service
    reverse_proxy grafana:3000 {
        header_up Host {host}
        header_up X-Real-IP {remote}
        header_up X-Forwarded-For {remote}
        header_up X-Forwarded-Proto {scheme}
    }

    # Enable compression
    encode gzip

    # Logging
    log {
        output file /var/log/caddy/grafana.log {
            roll_size 10mb
            roll_keep 5
        }
    }
}
